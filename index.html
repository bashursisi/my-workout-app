Okay, these are excellent suggestions to make the app more user-friendly and intuitive! Let's address them:

1.  **Unit Change (lbs to KG):** I'll update all weight input placeholders and the summary text.
2.  **Data Persistence in Input Fields:** I'll implement logic so that when you save progress for a particular day (e.g., Day 1), the next time you view Day 1, its input fields will be pre-filled with the data from your *most recent* workout for that specific day's structure.
3.  **Collapsible Progress Tab:** I'll redesign the Progress tab. Instead of a long table, entries will be grouped by date, and each date's workouts will be collapsible, showing a summary first and allowing you to expand for details.

Here are the key changes:

* **KG for Weight:** All "lbs" placeholders are now "KG". The "Total Volume" in the progress summary will now state "KG x Reps".
* **Input Field Persistence:**
    * When you navigate to a workout day (e.g., Day 1), the system will look up the most recent time you saved data for *that specific day's routine* (e.g., your last "Day 1: Upper Body Strength" workout).
    * If found, the weight, reps, notes, etc., for that session will automatically populate the input fields.
    * This means if you close and reopen the app, the last performed sets for the currently viewed day should appear.
* **Redesigned Progress Tab:**
    * Workouts in the "Progress" tab are now grouped by date.
    * Each date is a collapsible section. You'll see the date and the name(s) of the workout(s) performed.
    * Clicking on a date will expand it to show the detailed table of exercises and sets for that day's session(s), similar to the previous format but now neatly tucked away.

Here's the updated HTML and JavaScript:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Workout Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .safety-notice {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-tab {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .nav-tab:hover, .nav-tab.active {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .week-selector {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .week-btn {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            border: none;
            color: white;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .week-btn:hover, .week-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .day-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .day-btn {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            border: none;
            color: #2c3e50;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .day-btn:hover, .day-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
        }
        
        .day-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4facfe;
            display: none; 
        }
        
        .day-card.active {
            display: block; 
        }
        
        .day-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .exercise {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .exercise:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .exercise-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .exercise-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .exercise-description a { 
            color: #007bff;
            text-decoration: none;
        }
        .exercise-description a:hover {
            text-decoration: underline;
        }
        
        .alternatives {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alternatives strong {
            color: #1976d2;
        }
        
        .video-link {
            display: inline-block;
            background: #ff4757;
            color: white !important; 
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .video-link:hover {
            background: #ff3838;
            transform: scale(1.05);
            text-decoration: none; 
        }
        
        .sets-input {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .set-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-width: 200px; 
        }
        
        .set-group h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .input-row input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }
        
        .input-row label {
            font-size: 14px;
            color: #666;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: block; 
            margin: 20px auto 0 auto; 
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .progress-summary {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .progress-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .rest-day {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            text-align: center;
            padding: 40px;
            border-radius: 15px;
        }
        
        .swimming-day {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
            text-align: center;
            padding: 40px;
            border-radius: 15px;
        }
         .swimming-day .day-title { 
            -webkit-text-fill-color: white;
            color: white;
        }
        
        /* Styles for new collapsible progress */
        #progress-entries-container details {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #progress-entries-container summary {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #e0c3fc, #8ec5fc);
            color: #333;
            border-radius: 8px 8px 0 0;
            outline: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #progress-entries-container summary:hover {
            background: linear-gradient(135deg, #d0b3ec, #7eb5ec);
        }
        #progress-entries-container summary::after { /* Custom expand/collapse icon */
            content: '+';
            font-size: 1.5em;
            color: #555;
        }
        #progress-entries-container details[open] summary::after {
            content: '−';
        }
        .progress-entry-details {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }
        .progress-entry-details h4 {
            margin-top: 10px;
            margin-bottom: 5px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .progress-entry-details h4:first-child {
            margin-top: 0;
        }

        .progress-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px; /* Reduced margin for table inside details */
        }
        
        .progress-table th,
        .progress-table td {
            padding: 10px; /* Slightly reduced padding */
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em; /* Smaller font for table content */
        }
        
        .progress-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .progress-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px auto; 
            display: block;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .monthly-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .calendar-day {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative; 
        }
        
        .calendar-day:hover {
            background: #f0f0f0;
        }
        
        .calendar-day.workout-complete {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .calendar-day.today {
            border: 3px solid #ff4757;
            font-weight: bold;
        }
         .calendar-day.header {
            font-weight: bold;
            background: #f0f0f0;
            cursor: default;
        }
        .calendar-day.empty {
            background: #f9f9f9;
            cursor: default;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>🏋️‍♂️ Personal Workout Tracker</h1>
        
        <div class="safety-notice">
            ⚠️ IMPORTANT: This program is designed for your specific injuries (meniscus tear & hernias). 
            Always warm up, avoid heavy weights on damaged areas, and stop if you feel pain! Consult a doctor or physical therapist before starting any new exercise program.
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('workout', this)">Workout</button>
            <button class="nav-tab" onclick="showTab('progress', this)">Progress</button>
            <button class="nav-tab" onclick="showTab('calendar', this)">Calendar</button>
            <button class="nav-tab" onclick="showTab('analytics', this)">Analytics</button>
        </div>
        
        <div id="workout-tab" class="tab-content active">
            <div class="week-selector">
                <button class="week-btn active" onclick="showWeek(1, this)">Week 1-2</button>
                <button class="week-btn" onclick="showWeek(2, this)">Week 3-4</button>
                <button class="week-btn" onclick="showWeek(3, this)">Week 5-6</button>
                <button class="week-btn" onclick="showWeek(4, this)">Week 7+</button>
            </div>
            
            <div class="day-selector">
                <button class="day-btn active" onclick="showDay(1, this)">Day 1: Upper Body</button>
                <button class="day-btn" onclick="showDay(2, this)">Day 2: Lower Body</button>
                <button class="day-btn" onclick="showDay(3, this)">Day 3: Swimming</button>
                <button class="day-btn" onclick="showDay(4, this)">Day 4: Upper Body</button>
                <button class="day-btn" onclick="showDay(5, this)">Day 5: Lower Body</button>
                <button class="day-btn" onclick="showDay(6, this)">Day 6: Cardio/Core</button>
                <button class="day-btn" onclick="showDay(7, this)">Day 7: Rest</button>
            </div>
            
            <div id="day1" class="day-card active">
                <h2 class="day-title">Day 1: Upper Body Strength</h2>
                <div class="exercise">
                    <div class="exercise-name">Seated Chest Press Machine</div>
                    <div class="exercise-description">Builds chest, shoulders, and triceps while providing back support. Perfect for hernias as it eliminates spinal loading.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Incline Push-ups (hands elevated), Dumbbell Bench Press (light, controlled, back supported)</div>
                    <a href="https://www.youtube.com/watch?v=x3bJInRNvQA" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex1_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex1_s1_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex1_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex1_s2_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex1_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex1_s3_reps" placeholder="12-15"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Seated Cable Row</div>
                    <div class="exercise-description">Strengthens back muscles and improves posture. Seated position protects your hernias while building a strong back.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Seated Resistance Band Rows, Dumbbell Rows (one arm, supported on bench)</div>
                    <a href="https://www.youtube.com/watch?v=GZbfZ033f74" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex2_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex2_s1_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex2_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex2_s2_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex2_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex2_s3_reps" placeholder="12-15"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Seated Shoulder Press Machine</div>
                    <div class="exercise-description">Builds shoulder strength and size. Seated position provides back support and prevents strain on your hernias.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Seated Dumbbell Shoulder Press (light, back supported), Resistance Band Overhead Press</div>
                    <a href="https://www.youtube.com/watch?v=02t_gBL2c9E" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex3_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex3_s1_reps" placeholder="10-12"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex3_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex3_s2_reps" placeholder="10-12"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex3_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex3_s3_reps" placeholder="10-12"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Seated Dumbbell Bicep Curls</div>
                    <div class="exercise-description">Isolates biceps for growth. Seated position prevents cheating and protects your back from strain.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Cable Bicep Curls (standing or seated), Resistance Band Curls</div>
                    <a href="https://www.youtube.com/watch?v=NFzTWp2qpiE" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex4_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex4_s1_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex4_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex4_s2_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day1_ex4_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day1_ex4_s3_reps" placeholder="12-15"></div></div>
                    </div>
                </div>
                <button class="save-btn" onclick="saveWorkout('day1')">Save Day 1 Progress</button>
            </div>

            <div id="day2" class="day-card">
                <h2 class="day-title">Day 2: Lower Body (Knee-Safe)</h2>
                <div class="exercise">
                    <div class="exercise-name">Leg Press Machine</div>
                    <div class="exercise-description">Builds leg strength without stressing knees. Supported position protects hernias. Keep feet high on platform to reduce knee stress.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Wall Sits (short duration), Bodyweight Box Squats (to a high box/chair)</div>
                    <a href="https://www.youtube.com/watch?v=IZxyjW7MPJQ" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day2_ex1_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day2_ex1_s1_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day2_ex1_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day2_ex1_s2_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day2_ex1_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day2_ex1_s3_reps" placeholder="15-20"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Glute Bridges</div>
                    <div class="exercise-description">Strengthens glutes and hamstrings while being gentle on knees and back. Great for core stability too.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Single-leg Glute Bridges (if stable), Resistance Band Glute Bridges (band around thighs)</div>
                    <a href="https://www.youtube.com/watch?v=8bbE64Nu_2A" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Reps:</label><input type="number" id="day2_ex2_s1_reps" placeholder="15-20"><label>Hold (sec):</label><input type="number" id="day2_ex2_s1_hold" placeholder="2-3"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Reps:</label><input type="number" id="day2_ex2_s2_reps" placeholder="15-20"><label>Hold (sec):</label><input type="number" id="day2_ex2_s2_hold" placeholder="2-3"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Reps:</label><input type="number" id="day2_ex2_s3_reps" placeholder="15-20"><label>Hold (sec):</label><input type="number" id="day2_ex2_s3_hold" placeholder="2-3"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Calf Raises (e.g., Standing)</div>
                    <div class="exercise-description">Builds calf muscle. Can be done standing (bodyweight or with dumbbells) or on a leg press if available.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Single-Leg Calf Raises (bodyweight), Calf Raises on a Step, Leg Press Calf Presses. (Original: Seated Calf Raises)</div>
                    <a href="https://www.youtube.com/watch?v=Jfl4h3qR_lQ" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day2_ex3_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day2_ex3_s1_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day2_ex3_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day2_ex3_s2_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day2_ex3_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day2_ex3_s3_reps" placeholder="15-20"></div></div>
                    </div>
                </div>
                <button class="save-btn" onclick="saveWorkout('day2')">Save Day 2 Progress</button>
            </div>

            <div id="day3" class="day-card">
                <div class="swimming-day">
                    <h2 class="day-title">Day 3: Swimming & Pool Workout</h2>
                    <p style="font-size: 1.2em; margin-bottom: 20px;">🏊‍♂️ Perfect low-impact cardio for your injuries! Adjust frequency as desired.</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Swimming Routine (30-45 minutes)</h3>
                        <p>• 5 min warm-up: Easy freestyle or backstroke</p>
                        <p>• 20-30 min main set: Mix of strokes, focus on form</p>
                        <p>• 5-10 min cool-down: Easy swimming or water walking</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                        <h3>Water Aerobics / Gentle Movements (15-20 minutes, optional)</h3>
                        <p>• Leg Kicks (holding onto side)</p>
                        <p>• Arm Circles</p>
                        <p>• Water Walking (forward, backward, sideways)</p>
                    </div>
                     <button class="save-btn" style="margin-top: 20px;" onclick="saveWorkout('day3')">Log Swimming Session</button>
                </div>
            </div>

            <div id="day4" class="day-card">
                <h2 class="day-title">Day 4: Upper Body Focus</h2>
                 <div class="exercise">
                    <div class="exercise-name">Dumbbell Flyes (on bench)</div>
                    <div class="exercise-description">Isolates chest muscles. Use light-moderate weight, focus on controlled movement and squeezing the chest. Keep back supported.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Resistance Band Chest Flyes, Incline Push-ups. (Original: Pec Deck Machine)</div>
                    <a href="https://www.youtube.com/watch?v=eozbU_SJZbc" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex1_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex1_s1_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex1_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex1_s2_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex1_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex1_s3_reps" placeholder="12-15"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Machine Lat Pulldown (Wide Grip)</div>
                    <div class="exercise-description">Targets the latissimus dorsi (lats) for back width. Seated position provides good back support. (If no machine: use alternatives).</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Resistance Band Pulldowns (anchored high), Wide-Grip Bodyweight Rows (under a sturdy table or bar, feet on floor)</div>
                    <a href="https://www.youtube.com/watch?v=lueEJGjTuPQ" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex2_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex2_s1_reps" placeholder="10-12"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex2_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex2_s2_reps" placeholder="10-12"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex2_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex2_s3_reps" placeholder="10-12"></div></div>
                    </div>
                </div>
                 <div class="exercise">
                    <div class="exercise-name">Seated Lateral Raises (Dumbbells)</div>
                    <div class="exercise-description">Targets the medial (side) deltoids for shoulder width. Perform with light weight and controlled motion. Back supported.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Resistance Band Lateral Raises, Leaning Dumbbell Lateral Raise (one arm at a time)</div>
                    <a href="https://www.youtube.com/watch?v=3VcKaXpzqRo" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex3_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex3_s1_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex3_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex3_s2_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex3_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex3_s3_reps" placeholder="12-15"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Cable Tricep Pushdowns (Rope or Bar)</div>
                    <div class="exercise-description">Isolates the triceps muscles. Maintain good posture. (If no cable: use alternatives).</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Dumbbell Overhead Tricep Extension (seated or standing, one or two hands), Resistance Band Tricep Pushdowns/Overhead Extensions, Close-Grip Push-ups (hands elevated if needed)</div>
                    <a href="https://www.youtube.com/watch?v=2-LAMcpzODU" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex4_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex4_s1_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex4_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex4_s2_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex4_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex4_s3_reps" placeholder="12-15"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Dumbbell Concentration Curls</div>
                    <div class="exercise-description">Excellent for isolating the biceps. Sit and brace your working arm's elbow against your inner thigh.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Dumbbell Spider Curls (chest on incline bench), Incline Dumbbell Curls. (Original: Machine Preacher Curls)</div>
                    <a href="https://www.youtube.com/watch?v=0AUGkch3tzc" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex5_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex5_s1_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex5_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex5_s2_reps" placeholder="12-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day4_ex5_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day4_ex5_s3_reps" placeholder="12-15"></div></div>
                    </div>
                </div>
                <button class="save-btn" onclick="saveWorkout('day4')">Save Day 4 Progress</button>
            </div>

            <div id="day5" class="day-card">
                <h2 class="day-title">Day 5: Lower Body Focus</h2>
                <div class="exercise">
                    <div class="exercise-name">Leg Press Machine</div>
                    <div class="exercise-description">Builds leg strength without stressing knees. Supported position protects hernias. (If no machine: use alternatives).</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Dumbbell Goblet Squats (light, focus on form), Bodyweight Squats, Wall Sits.</div>
                     <a href="https://www.youtube.com/watch?v=IZxyjW7MPJQ" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex1_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex1_s1_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex1_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex1_s2_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex1_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex1_s3_reps" placeholder="15-20"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Sliding Leg Curls (Floor)</div>
                    <div class="exercise-description">Isolates hamstrings. Lie on back, hips bridged, slide feet out and curl back in using socks/towels on a slippery floor.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Resistance Band Hamstring Curls, Glute Bridges with feet further away. (Original: Hamstring Curl Machine)</div>
                    <a href="https://www.youtube.com/watch?v=y2wAlKcY6iY" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Reps:</label><input type="number" id="day5_ex2_s1_reps" placeholder="10-15"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Reps:</label><input type="number" id="day5_ex2_s2_reps" placeholder="10-15"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Reps:</label><input type="number" id="day5_ex2_s3_reps" placeholder="10-15"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Leg Extension Machine (Light Weight)</div>
                    <div class="exercise-description">Targets the quadriceps. Use very light weight, focus on controlled movement. (If no machine: use alternatives).</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Bodyweight Shallow Squats (if no pain), Step-ups onto a low platform (controlled), Terminal Knee Extensions (with band)</div>
                    <a href="https://www.youtube.com/watch?v=YyvSfVjQeL0" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex3_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex3_s1_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex3_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex3_s2_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex3_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex3_s3_reps" placeholder="15-20"></div></div>
                    </div>
                </div>
                 <div class="exercise">
                    <div class="exercise-name">Glute Bridges</div>
                    <div class="exercise-description">Strengthens glutes and hamstrings while being gentle on knees and back. Great for core stability too.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Single-leg Glute Bridges (if stable), Resistance Band Glute Bridges (band around thighs)</div>
                    <a href="https://www.youtube.com/watch?v=8bbE64Nu_2A" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Reps:</label><input type="number" id="day5_ex4_s1_reps" placeholder="15-20"><label>Hold (sec):</label><input type="number" id="day5_ex4_s1_hold" placeholder="2-3"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Reps:</label><input type="number" id="day5_ex4_s2_reps" placeholder="15-20"><label>Hold (sec):</label><input type="number" id="day5_ex4_s2_hold" placeholder="2-3"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Reps:</label><input type="number" id="day5_ex4_s3_reps" placeholder="15-20"><label>Hold (sec):</label><input type="number" id="day5_ex4_s3_hold" placeholder="2-3"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Calf Raises (e.g., Standing on Step)</div>
                    <div class="exercise-description">Builds calf muscle. Use a step for greater range of motion. Hold dumbbells for added resistance if comfortable.</div>
                    <div class="alternatives"><strong>Alternatives:</strong> Single-Leg Calf Raises, Standing Calf Raises (flat ground). (Original: Seated Calf Raises)</div>
                    <a href="https://www.youtube.com/watch?v=g_s0s4aUStg" class="video-link" target="_blank">📺 Watch Demo</a>
                    <div class="sets-input">
                        <div class="set-group"><h4>Set 1</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex5_s1_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex5_s1_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 2</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex5_s2_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex5_s2_reps" placeholder="15-20"></div></div>
                        <div class="set-group"><h4>Set 3</h4><div class="input-row"><label>Weight:</label><input type="number" id="day5_ex5_s3_weight" placeholder="KG"><label>Reps:</label><input type="number" id="day5_ex5_s3_reps" placeholder="15-20"></div></div>
                    </div>
                </div>
                <button class="save-btn" onclick="saveWorkout('day5')">Save Day 5 Progress</button>
            </div>
            
            <div id="day6" class="day-card">
                 <h2 class="day-title">Day 6: Light Cardio & Core</h2>
                <div class="exercise">
                    <div class="exercise-name">Stationary Bike or Elliptical Trainer</div>
                    <div class="exercise-description">
                        Low-impact cardiovascular exercise. Adjust resistance/incline to a comfortable level.
                        <br>Bike Demo: <a href="https://www.youtube.com/watch?v=xFG3xY5e6go" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-bottom: 5px;">📺 Bike Setup</a>
                        <br>Elliptical Demo: <a href="https://www.youtube.com/watch?v=r3ALgD334dY" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px;">📺 Elliptical Use</a>
                        <p><strong>Duration:</strong> 20-30 minutes</p>
                        <p><strong>Intensity:</strong> Light to Moderate (able to hold a conversation)</p>
                    </div>
                     <div class="sets-input"> 
                        <div class="set-group"><h4>Cardio Session</h4><div class="input-row"><label>Duration (min):</label><input type="number" id="day6_ex1_s1_duration" placeholder="20-30"><label>Notes:</label><input type="text" id="day6_ex1_s1_notes" placeholder="Bike/Elliptical?" style="width:100px;"></div></div>
                    </div>
                </div>
                <div class="exercise">
                    <div class="exercise-name">Core (Hernia-Safe)</div>
                     <div class="exercise-description">
                        Focus on gentle core engagement. Avoid crunches or sit-ups. Perform slowly and with control.
                        <p>• <strong>Pelvic Tilts:</strong> 3 sets of 10-15 reps <a href="https://www.youtube.com/watch?v=r_srf_7sYlc" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">📺 Demo</a></p>
                        <p>• <strong>Heel Slides:</strong> 3 sets of 10-15 reps per leg <a href="https://www.youtube.com/watch?v=5oY4aZ3Eq3Y" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">📺 Demo</a></p>
                        <p>• <strong>Bird-Dog (modified if needed):</strong> 3 sets of 8-10 reps per side <a href="https://www.youtube.com/watch?v=wiFNA3sqjCA" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">📺 Demo</a></p>
                        <p>• <strong>Dead Bug (modified, e.g., only leg movements or only arm movements):</strong> 3 sets of 8-10 reps per side <a href="https://www.youtube.com/watch?v=g_BYB0R-DRM" target="_blank" class="video-link" style="font-size:0.8em; padding: 4px 8px; margin-left:5px;">📺 Demo</a></p>
                    </div>
                     <div class="sets-input">
                        <div class="set-group"><h4>Core Completion</h4><div class="input-row"><label>Completed:</label><input type="checkbox" id="day6_ex2_s1_completed" style="width:auto;"> <label>Notes:</label><input type="text" id="day6_ex2_s1_notes" placeholder="Any discomfort?" style="width:100px;"></div></div>
                    </div>
                </div>
                <button class="save-btn" onclick="saveWorkout('day6')">Log Cardio & Core</button>
            </div>

            <div id="day7" class="day-card">
                <div class="rest-day">
                    <h2 class="day-title" style="-webkit-text-fill-color: #2c3e50; color: #2c3e50;">Day 7: Rest & Recovery</h2>
                    <p style="font-size: 1.2em; margin-bottom: 20px;">🧘‍♂️ Your body needs time to repair and rebuild. Enjoy your rest day!</p>
                    <p>Focus on: Light stretching, hydration, good nutrition. Consider sauna if available and you enjoy it for recovery.</p>
                </div>
                 <button class="save-btn" onclick="saveWorkout('day7')">Log Rest Day</button>
            </div>

        </div>

        <div id="progress-tab" class="tab-content">
            <h2>Track Your Progress</h2>
            <p>This section shows your saved workout data. Click a date to expand/collapse details.</p>
            <div class="progress-summary">
                <h3>Overall Summary</h3>
                <p>Workouts Logged: <span id="workouts-completed">0</span></p>
                <p>Total Volume (Approx. KG x Reps): <span id="total-volume">0</span></p>
            </div>
            <div class="progress-chart">
                <div class="chart-card">
                    <h3 class="chart-title">Volume Over Time (Example)</h3>
                    <canvas id="volumeChart"></canvas>
                </div>
                 <div class="chart-card">
                    <h3 class="chart-title">Workouts Per Week (Example)</h3>
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
             <div id="progress-entries-container">
                 <p style="text-align:center;">No data saved yet. Click "Save Day X Progress" after workouts.</p>
             </div>
            <button class="export-btn" onclick="exportProgress()">Export Progress (CSV)</button>
        </div>

        <div id="calendar-tab" class="tab-content">
            <h2>Workout Calendar</h2>
            <p>View your completed workouts on a calendar. Click "Save Day X Progress" on the workout tab to mark days here.</p>
            <div class="monthly-view" id="monthly-calendar-view">
            </div>
        </div>

        <div id="analytics-tab" class="tab-content">
            <h2>Workout Analytics</h2>
            <p>Deeper insights into your workout patterns and performance. (Future Feature)</p>
        </div>

    </div>

    <script>
        // --- Tab Navigation ---
        function showTab(tabId, clickedButton) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            const selectedTabContent = document.getElementById(tabId + '-tab');
            if (selectedTabContent) selectedTabContent.classList.add('active');
            if (clickedButton) clickedButton.classList.add('active');

            if (tabId === 'calendar') generateCalendar(); 
            if (tabId === 'progress') updateProgressTable();
        }

        // --- Week Selector ---
        function showWeek(weekNumber, clickedButton) {
            const weekButtons = document.querySelectorAll('.week-btn');
            weekButtons.forEach(button => button.classList.remove('active'));
            if (clickedButton) clickedButton.classList.add('active');
        }

        // --- Day Selector ---
        function showDay(dayNumber, clickedButton) {
            const dayCards = document.querySelectorAll('.day-card');
            dayCards.forEach(card => card.classList.remove('active'));
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons.forEach(button => button.classList.remove('active'));

            const dayId = 'day' + dayNumber;
            const selectedDayCard = document.getElementById(dayId);
            if (selectedDayCard) {
                selectedDayCard.classList.add('active');
                populateDayInputs(dayId); // Populate inputs for the shown day
            }
            if (clickedButton) clickedButton.classList.add('active');
        }

        // --- Find latest workout data for a specific dayId ---
        function findLatestWorkoutForDay(dayId) {
            const workoutLog = JSON.parse(localStorage.getItem('workoutLogV4')) || {}; // Updated log key
            let latestEntry = null;
            
            const sortedDates = Object.keys(workoutLog).sort((a, b) => new Date(b) - new Date(a)); 

            for (const date of sortedDates) {
                if (workoutLog[date][dayId]) {
                    latestEntry = workoutLog[date][dayId];
                    break; 
                }
            }
            return latestEntry;
        }
        
        // --- Populate inputs with latest data for the day ---
        function populateDayInputs(dayId) {
            const dayCard = document.getElementById(dayId);
            if (!dayCard) return;

            // Clear existing values first
            const allInputs = dayCard.querySelectorAll('input[type="number"], input[type="text"]');
            allInputs.forEach(input => input.value = '');
            const allCheckboxes = dayCard.querySelectorAll('input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => checkbox.checked = false);
            
            const latestDayData = findLatestWorkoutForDay(dayId);
            if (!latestDayData || !latestDayData.exercises) {
                return; // No data or no exercises in data for this dayId
            }

            latestDayData.exercises.forEach((exercise, exIndex) => {
                const exerciseElement = dayCard.querySelectorAll('.exercise')[exIndex];
                if (!exerciseElement) return;

                exercise.sets.forEach((set, setIndex) => {
                    const setGroupElement = exerciseElement.querySelectorAll('.set-group')[setIndex];
                    if (!setGroupElement && exercise.sets.length === 1 && Object.keys(set).length > 1) { // Handle single set inputs not in .set-group (like cardio notes)
                         for (const field in set) {
                            if (field === 'status') continue;
                             // Construct ID based on naming pattern for Day 6 special inputs
                             // e.g. day6_ex1_s1_duration, day6_ex2_s1_completed
                            const inputId = `${dayId}_ex${exIndex + 1}_s${setIndex + 1}_${field}`;
                            const inputElement = document.getElementById(inputId);
                            if (inputElement) {
                                if (inputElement.type === 'checkbox') {
                                    inputElement.checked = set[field];
                                } else {
                                    inputElement.value = set[field];
                                }
                            }
                        }
                    } else if (setGroupElement) { // Standard set groups
                        for (const field in set) {
                            if (field === 'set') continue; 
                            // Find input within this setGroup that corresponds to the field
                            // This assumes input IDs are structured to allow finding them if needed,
                            // or that fields match input names/placeholders if IDs are not strictly followed for all.
                            // For now, let's assume IDs are `dayX_exY_sZ_field`
                            const inputId = `${dayId}_ex${exIndex + 1}_s${setIndex + 1}_${field}`;
                            const inputElement = document.getElementById(inputId);
                            
                            if (inputElement) {
                                if (inputElement.type === 'checkbox') {
                                    inputElement.checked = set[field];
                                } else {
                                    inputElement.value = set[field];
                                }
                            }
                        }
                    }
                });
            });
        }
        
        // --- Save Workout Data ---
        function saveWorkout(dayId) {
            const dayCard = document.getElementById(dayId);
            if (!dayCard) {
                alert('Error: Could not find workout data to save.');
                return;
            }

            const timestamp = new Date();
            const dateString = timestamp.toISOString().slice(0, 10);
            let workoutLog = JSON.parse(localStorage.getItem('workoutLogV4')) || {}; // Use a new version for log structure
            if (!workoutLog[dateString]) workoutLog[dateString] = {};
            
            const dayTitleElement = dayCard.querySelector('.day-title');
            const dayName = dayTitleElement ? dayTitleElement.textContent.trim() : `Day ${dayId.replace('day','')}`;

            let dayLogEntry = {
                dayName: dayName,
                timestamp: timestamp.toISOString(),
                exercises: []
            };

            const exercises = dayCard.querySelectorAll('.exercise');
            if (exercises.length > 0) {
                exercises.forEach((exerciseEl, exIndex) => {
                    const exerciseNameEl = exerciseEl.querySelector('.exercise-name');
                    const exerciseName = exerciseNameEl ? exerciseNameEl.textContent.trim() : `Unnamed Exercise`;
                    let exerciseData = { name: exerciseName, sets: [] };

                    const setGroups = exerciseEl.querySelectorAll('.set-group');
                    if (setGroups.length > 0) {
                        setGroups.forEach((setGroup, setIndex) => {
                            let setData = { set: setIndex + 1 }; // Keep set number for display
                            const inputs = setGroup.querySelectorAll('input');
                            inputs.forEach(input => {
                                const fieldId = input.id;
                                // Try to get a clean field name: dayX_exY_sZ_**field**
                                const fieldNameMatch = fieldId.match(/_s\d+_([a-zA-Z_]+)$/);
                                const fieldName = fieldNameMatch ? fieldNameMatch[1] : fieldId.substring(fieldId.lastIndexOf('_') + 1);
                                
                                if (input.type === 'checkbox') {
                                    setData[fieldName] = input.checked;
                                } else if (input.value.trim() !== '') {
                                    setData[fieldName] = input.value.trim();
                                }
                            });
                            if (Object.keys(setData).length > 1) { // if it has more than just the 'set' number
                                exerciseData.sets.push(setData);
                            }
                        });
                    }
                    // Ensure single-entry exercises like cardio notes are also captured
                    else if (exerciseEl.querySelector('.input-row')) { // for Day 6 cardio style
                         let setData = {};
                         const inputs = exerciseEl.querySelectorAll('.input-row input');
                         inputs.forEach(input => {
                            const fieldId = input.id;
                            const fieldNameMatch = fieldId.match(/_s\d+_([a-zA-Z_]+)$/);
                            const fieldName = fieldNameMatch ? fieldNameMatch[1] : fieldId.substring(fieldId.lastIndexOf('_') + 1);
                            if (input.type === 'checkbox') {
                                setData[fieldName] = input.checked;
                            } else if (input.value.trim() !== '') {
                                setData[fieldName] = input.value.trim();
                            }
                         });
                         if(Object.keys(setData).length > 0) exerciseData.sets.push(setData);
                    }

                    if (exerciseData.sets.length > 0) {
                         dayLogEntry.exercises.push(exerciseData);
                    }
                });
            } else { 
                 if (dayId === 'day3' || dayId === 'day7') { 
                    dayLogEntry.exercises.push({ name: dayName, sets: [{ status: "Logged" }] });
                }
            }
            
            workoutLog[dateString][dayId] = dayLogEntry; 
            localStorage.setItem('workoutLogV4', JSON.stringify(workoutLog));
            alert(dayName + ' progress saved for ' + dateString + '!');
            updateProgressTable();
            generateCalendar(); 
        }

        // --- Update Progress Table (Collapsible) ---
        function updateProgressTable() {
            const workoutLog = JSON.parse(localStorage.getItem('workoutLogV4')) || {};
            const container = document.getElementById('progress-entries-container');
            if (!container) return;
            container.innerHTML = ''; 

            let hasData = false;
            const sortedDates = Object.keys(workoutLog).sort((a,b) => new Date(b) - new Date(a));

            if (sortedDates.length === 0) {
                 container.innerHTML = '<p style="text-align:center;">No data saved yet. Click "Save Day X Progress" after workouts.</p>';
                 updateOverallSummary(); // Still update summary even if no table data
                 return;
            }

            sortedDates.forEach(date => {
                hasData = true;
                const dateWorkouts = workoutLog[date];
                
                const detailsEl = document.createElement('details');
                detailsEl.classList.add('progress-entry');
                
                const summaryEl = document.createElement('summary');
                let summaryText = date;
                const dayNamesOnDate = Object.values(dateWorkouts).map(entry => entry.dayName).join(' & ');
                summaryText += ` - ${dayNamesOnDate}`;
                summaryEl.textContent = summaryText;
                detailsEl.appendChild(summaryEl);

                const entryDetailsDiv = document.createElement('div');
                entryDetailsDiv.classList.add('progress-entry-details');

                Object.keys(dateWorkouts).forEach(dayIdKey => {
                    const dayEntry = dateWorkouts[dayIdKey];
                    const dayHeader = document.createElement('h4');
                    dayHeader.textContent = dayEntry.dayName;
                    entryDetailsDiv.appendChild(dayHeader);

                    const table = document.createElement('table');
                    table.classList.add('progress-table');
                    const thead = table.createTHead();
                    const headerRow = thead.insertRow();
                    const headers = ['Exercise', 'Set', 'Weight (KG)', 'Reps', 'Hold', 'Duration', 'Notes/Status'];
                    headers.forEach(text => {
                        const th = document.createElement('th');
                        th.textContent = text;
                        headerRow.appendChild(th);
                    });
                    const tbody = table.createTBody();

                    dayEntry.exercises.forEach(exercise => {
                        if (exercise.sets.length === 0 || !exercise.sets[0]) { // Handle no sets/status
                            const row = tbody.insertRow();
                            row.insertCell().textContent = exercise.name;
                            for(let i=0; i<6; i++) row.insertCell().textContent = 'N/A'; 
                        } else if (!exercise.sets[0].set && exercise.sets[0].status) { // Logged days like Rest/Swim
                             const row = tbody.insertRow();
                            row.insertCell().textContent = exercise.name;
                            for(let i=0; i<6; i++) row.insertCell().textContent = 'N/A';
                            row.insertCell().textContent = exercise.sets[0].status;
                        }
                        else {
                            exercise.sets.forEach((set, index) => {
                                const row = tbody.insertRow();
                                row.insertCell().textContent = exercise.name;
                                row.insertCell().textContent = set.set || (index + 1); // Use index if set number not present
                                row.insertCell().textContent = set.weight || 'N/A';
                                row.insertCell().textContent = set.reps || 'N/A';
                                row.insertCell().textContent = set.hold || 'N/A';
                                row.insertCell().textContent = set.duration || 'N/A';
                                row.insertCell().textContent = set.notes || (set.completed !== undefined ? (set.completed ? 'Completed' : 'Not Done') : 'N/A');
                            });
                        }
                    });
                    entryDetailsDiv.appendChild(table);
                });
                detailsEl.appendChild(entryDetailsDiv);
                container.appendChild(detailsEl);
            });
            
            updateOverallSummary();
        }
        
        function updateOverallSummary() {
            const workoutLog = JSON.parse(localStorage.getItem('workoutLogV4')) || {};
            let workoutsCompleted = 0;
            let totalVolume = 0;

            Object.keys(workoutLog).forEach(date => {
                Object.keys(workoutLog[date]).forEach(dayIdKey => {
                    workoutsCompleted++; 
                    const dayData = workoutLog[date][dayIdKey];
                    if (dayData.exercises) {
                        dayData.exercises.forEach(exercise => {
                            if (exercise.sets) {
                                exercise.sets.forEach(set => {
                                    const weight = parseFloat(set.weight);
                                    const reps = parseInt(set.reps);
                                    if (!isNaN(weight) && !isNaN(reps)) {
                                        totalVolume += weight * reps;
                                    }
                                });
                            }
                        });
                    }
                });
            });

            document.getElementById('workouts-completed').textContent = workoutsCompleted;
            document.getElementById('total-volume').textContent = totalVolume.toLocaleString() + ' (KG x Reps approx)';
        }

        function exportProgress() {
            const workoutLog = JSON.parse(localStorage.getItem('workoutLogV4')) || {};
            let csvContent = "Date,Day Name,Exercise Name,Set,Weight (KG),Reps,Hold,Duration,Notes/Status\n";

            Object.keys(workoutLog).sort().forEach(date => { 
                Object.keys(workoutLog[date]).forEach(dayIdKey => {
                    const dayEntry = workoutLog[date][dayIdKey];
                    if (dayEntry.exercises) {
                        dayEntry.exercises.forEach(exercise => {
                            if (exercise.sets && (exercise.sets.length === 0 || !exercise.sets[0].set && exercise.sets[0].status)) {
                                csvContent += `${date},"${dayEntry.dayName}","${exercise.name}",N/A,N/A,N/A,N/A,N/A,"${exercise.sets[0]?.status || 'Logged'}"\n`;
                            } else if (exercise.sets) {
                                exercise.sets.forEach((set, index) => {
                                    csvContent += `${date},"${dayEntry.dayName}","${exercise.name}",${set.set || (index+1)},${set.weight || ''},${set.reps || ''},${set.hold || ''},${set.duration || ''},"${set.notes || (set.completed !== undefined ? (set.completed ? 'Completed' : 'Not Done') : '')}"\n`;
                                });
                            }
                        });
                    }
                });
            });

            if (csvContent.split("\n").length <= 1) {
                alert("No data to export!");
                return;
            }
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "workout_progress.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                 alert("CSV export not supported by this browser.");
            }
        }
        
        function generateCalendar() {
            const calendarView = document.getElementById('monthly-calendar-view');
            const workoutLog = JSON.parse(localStorage.getItem('workoutLogV4')) || {};
            if (!calendarView) return;
            calendarView.innerHTML = ''; 

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); 

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(name => {
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-day', 'header');
                dayHeader.textContent = name;
                calendarView.appendChild(dayHeader);
            });
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day', 'empty');
                calendarView.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                dayCell.textContent = day;
                
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (workoutLog[dateStr] && Object.keys(workoutLog[dateStr]).length > 0) {
                    dayCell.classList.add('workout-complete');
                    let workoutTitles = [];
                     Object.values(workoutLog[dateStr]).forEach(dayLog => {
                        if(dayLog && dayLog.dayName) workoutTitles.push(dayLog.dayName);
                    });
                    dayCell.title = "Logged: " + workoutTitles.join('; ');
                }

                if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                    dayCell.classList.add('today');
                }
                dayCell.onclick = () => {
                    if (dayCell.title) {
                        alert(`On ${dateStr}:\n${dayCell.title}`);
                    } else {
                        alert('No workout logged for ' + dateStr);
                    }
                };
                calendarView.appendChild(dayCell);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Set initial active tab and day
            showTab('workout', document.querySelector('.nav-tab[onclick*="workout"]'));
            
            const initialActiveDayButton = document.querySelector('.day-btn.active') || document.querySelector('.day-btn'); // Fallback to first day button
            if(initialActiveDayButton){
                // Simulate a click to trigger showDay and populateDayInputs correctly
                initialActiveDayButton.click(); 
            } else { // If no day buttons, at least try to populate Day 1 if it's active
                const activeDayCard = document.querySelector('.day-card.active');
                 if (activeDayCard) {
                    populateDayInputs(activeDayCard.id);
                }
            }
            
            showWeek(1, document.querySelector('.week-btn.active')); // Activate default week
            updateProgressTable(); // Initial load for progress tab data

            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded. Charts will not be displayed.');
            }
        });
    </script>
</body>
</html>
```
